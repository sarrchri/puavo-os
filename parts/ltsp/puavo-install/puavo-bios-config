#!/bin/sh

set -eu

prepare_hp_utils() {
  puavo-pkg install /usr/share/puavo-pkg/packages/hp-bios-utils.tar.gz
  export PATH="/opt/hp/hp-flash:${PATH}"
  hp_utils_dir='/opt/hp/hp-flash'
}

use_hp_utils() {
  prepare_hp_utils

  cat << EOF
> Running Bash for you, the current working directory is "${hp_utils_dir}".
> It has "hp-flash" and "hp-repsetup".
> PATH is $PATH
> Exit Bash when done.
EOF
  (cd "$hp_utils_dir" && bash)
}

hp_wget_latest_and_flash() {
  prepare_hp_utils

  mainboard_sysid=$(dmidecode -s baseboard-product-name)
  hp_ftp_url="https://ftp.ext.hp.com/pub/pcbios"
  (cd "$hp_utils_dir" && \
    wget "$hp_ftp_url/$mainboard_sysid/$mainboard_sysid.xml" && \
    hp_latest_bios="$(xmllint --xpath "string(/BIOS/Rel/@Bin)" $mainboard_sysid.xml)" && \
    wget "$hp_ftp_url/$mainboard_sysid/$hp_latest_bios" && \
    hp-flash "$hp_latest_bios")
}

import_config_student_laptop() {
  prepare_hp_utils

  (cd "$hp_utils_dir" && hp-repsetup -s HpSetup-student-laptop.txt)
}

import_config_usb_stick_factory() {
  prepare_hp_utils

  (cd "$hp_utils_dir" && hp-repsetup -s HpSetup-usb-factory.txt)
}

ask_choice() {
  choices=$(cat <<'EOF'
Flash latest BIOS (HP)
Import Student laptop BIOS Config
Import USB Stick factory BIOS Config
use HP BIOS utilities
exit
EOF
)
  printf "%s" "$choices" | fzf --height=7 --layout=reverse-list
}

printf "\n"
printf ">>> Welcome to puavo-bios-config!\n"
printf ">>> What do you want to do?\n\n"
while ! chosen=$(ask_choice) || [ -z "$chosen" ]; do
  :
done

printf ">> You chose '${chosen}'\n"

case "$chosen" in
  exit)
    exit 0
    ;;
  'Flash latest BIOS (HP)')
    hp_wget_latest_and_flash
    sleep 3
    ;;
  'Import Student laptop BIOS Config')
    import_config_student_laptop
    sleep 3
    ;;
  'Import USB Stick factory BIOS Config')
    import_config_usb_stick_factory
    sleep 3
    ;;
  'use HP BIOS utilities')
    use_hp_utils
    ;;
esac
